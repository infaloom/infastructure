---
- name: Initialize K3s Cluster on agents
  hosts: agents
  become: true
  gather_facts: true
  
  vars:
    k3s_flannel_iface: enp7s0

  tasks:
    - name: Check if K3s is already installed (simple check)
      ansible.builtin.stat:
        path: /etc/rancher/k3s/k3s.yaml
      register: k3s_config_file

    - name: Ensure K3s configuration directory exists
      file:
        path: /etc/rancher/k3s
        recurse: true
        state: directory
      when: not k3s_config_file.stat.exists

    - name: Create/Update K3s registry mirrors configuration
      ansible.builtin.copy:
        dest: /etc/rancher/k3s/registries.yaml # The target file path
        content: |                             # Use literal block scalar for multi-line content
          mirrors:
            docker.io:
            registry.k8s.io:
        owner: root          # Or appropriate user K3s runs as
        group: root          # Or appropriate group K3s runs as
        mode: '0644'         # Standard config file permissions
        backup: yes          # Optional: Creates a timestamped backup if the file changes
      when: not k3s_config_file.stat.exists

    - name: Get IP address for the specified flannel interface
      ansible.builtin.set_fact:
        k3s_node_ip: "{{ ansible_facts[k3s_flannel_iface]['ipv4']['address'] }}"
      when:
        - not k3s_config_file.stat.exists
        - k3s_flannel_iface in ansible_facts
        - ansible_facts[k3s_flannel_iface].ipv4 is defined
      # Fail if the interface or IP isn't found in facts
      failed_when: >
        k3s_flannel_iface not in ansible_facts or
        'ipv4' not in ansible_facts[k3s_flannel_iface] or
        'address' not in ansible_facts[k3s_flannel_iface]['ipv4']

    - name: Display determined Node IP
      ansible.builtin.debug:
        msg: "Using Node IP {{ k3s_node_ip }} for interface {{ k3s_flannel_iface }}"
      when: not k3s_config_file.stat.exists

    - name: Install K3s Agent
      ansible.builtin.shell: curl -sfL https://get.k3s.io | sh -s - agent --server https://10.0.1.11:6443 --flannel-iface enp7s0 --node-ip {{ k3s_node_ip }}
      args:
        executable: /bin/bash # Explicitly use bash if needed
        # This prevents the command from showing up in logs if you have sensitive info (token is in env)
        # no_log: true
      environment:
        K3S_TOKEN: "{{ lookup('ansible.builtin.env', 'K3S_TOKEN') }}"
        INSTALL_K3S_VERSION: "{{ lookup('ansible.builtin.env', 'INSTALL_K3S_VERSION') }}"
      register: k3s_install_result
      changed_when: "'Started k3s' in k3s_install_result.stdout" # Adjust if needed based on actual output
      when: not k3s_config_file.stat.exists # Only run if the config file doesn't exist
